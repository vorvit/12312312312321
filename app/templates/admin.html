{% extends "base.html" %}

{% block title %}Admin Panel - IFC Auth Service{% endblock %}

{% block body_class %}admin-page{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-cog me-2"></i>Admin Panel</h1>
            <div class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                Administrator Access
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Total Users</h4>
                        <h2 id="totalUsers">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Active Users</h4>
                        <h2 id="activeUsers">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Admins</h4>
                        <h2 id="adminUsers">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-shield fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Storage Used</h4>
                        <h2 id="totalStorage">0 GB</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-hdd fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Management -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>Users Management
                    </h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshUsers()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportUsers()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchUsers" placeholder="Search users...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterRole">
                            <option value="">All Roles</option>
                            <option value="admin">Admins</option>
                            <option value="user">Users</option>
                        </select>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="badge bg-primary" id="usersCount">Loading...</span>
                        <span class="text-muted ms-2" id="filterInfo"></span>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Clear Filters
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Full Name</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Storage</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Users pagination">
                    <ul class="pagination justify-content-center" id="usersPagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- System Information -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>System Information
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Service Status:</dt>
                    <dd class="col-sm-8"><span class="badge bg-success">Online</span></dd>
                    
                    <dt class="col-sm-4">Database:</dt>
                    <dd class="col-sm-8"><span class="badge bg-info">Connected</span></dd>
                    
                    <dt class="col-sm-4">Storage:</dt>
                    <dd class="col-sm-8"><span class="badge bg-warning">MinIO</span></dd>
                    
                    <dt class="col-sm-4">Version:</dt>
                    <dd class="col-sm-8">1.0.0</dd>
                </dl>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="createUser()">
                        <i class="fas fa-user-plus me-2"></i>Create User
                    </button>
                    <button class="btn btn-outline-warning" onclick="systemSettings()">
                        <i class="fas fa-cog me-2"></i>System Settings
                    </button>
                    <button class="btn btn-outline-info" onclick="viewLogs()">
                        <i class="fas fa-file-alt me-2"></i>View Logs
                    </button>
                    <button class="btn btn-outline-danger" onclick="backupData()">
                        <i class="fas fa-download me-2"></i>Backup Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>System Logs
                    </h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadLogs('main')">Main</button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadLogs('auth')">Auth</button>
                        <button class="btn btn-outline-success btn-sm" onclick="loadLogs('files')">Files</button>
                        <button class="btn btn-outline-warning btn-sm" onclick="loadLogs('admin')">Admin</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="logsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Загрузка логов...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="createEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="createEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="createUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="createUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="createPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="createPassword" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createIsAdmin">
                            <label class="form-check-label" for="createIsAdmin">
                                Administrator
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="createStorageQuota" class="form-label">Storage Quota (GB)</label>
                        <input type="number" class="form-control" id="createStorageQuota" value="1" min="0.1" step="0.1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive">
                            <label class="form-check-label" for="editIsActive">
                                Active
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsAdmin">
                            <label class="form-check-label" for="editIsAdmin">
                                Administrator
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editStorageQuota" class="form-label">Storage Quota (GB)</label>
                        <input type="number" class="form-control" id="editStorageQuota" min="0.1" step="0.1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditUser()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- System Settings Modal -->
<div class="modal fade" id="systemSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>General Settings</h6>
                        <div class="mb-3">
                            <label class="form-label">Site Name</label>
                            <input type="text" class="form-control" id="siteName" value="IFC Auth Service">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Default Storage Quota (GB)</label>
                            <input type="number" class="form-control" id="defaultQuota" value="1" min="0.1" step="0.1">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Security Settings</h6>
                        <div class="mb-3">
                            <label class="form-label">Session Timeout (minutes)</label>
                            <input type="number" class="form-control" id="sessionTimeout" value="60" min="5">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requireEmailVerification" checked>
                                <label class="form-check-label" for="requireEmailVerification">
                                    Require Email Verification
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSystemSettings()">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Backup Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Backup Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Backup Type</label>
                    <select class="form-select" id="backupType">
                        <option value="full">Full Backup (Database + Files)</option>
                        <option value="database">Database Only</option>
                        <option value="files">Files Only</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Compression</label>
                    <select class="form-select" id="compression">
                        <option value="zip">ZIP</option>
                        <option value="tar">TAR</option>
                        <option value="none">No Compression</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startBackup()">Start Backup</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/admin.js"></script>
<script>
let currentPage = 1;
let pageSize = 10;
let allUsers = [];

// Load admin data
async function loadAdminData() {
    const token = localStorage.getItem('access_token');
    console.log('Admin: Checking token...');
    
    if (!token) {
        console.log('Admin: No token found, redirecting to login');
        window.location.href = '/login';
        return;
    }
    
    console.log('Admin: Token found:', token.substring(0, 20) + '...');
    
    try {
        // First check if user is admin
        console.log('Admin: Checking user permissions...');
        const userResponse = await fetch('/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!userResponse.ok) {
            console.log('Admin: User check failed, redirecting to login');
            localStorage.removeItem('access_token');
            window.location.href = '/login';
            return;
        }
        
        const user = await userResponse.json();
        console.log('Admin: User data:', user);
        
        if (!user.is_admin) {
            console.log('Admin: User is not admin, redirecting to dashboard');
            window.location.href = '/dashboard';
            return;
        }
        
        console.log('Admin: User is admin, loading data...');
        
        // Load statistics
        const statsResponse = await fetch('/admin/stats', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        console.log('Admin: Stats response:', statsResponse.status);
        
        if (statsResponse.ok) {
            const body = await statsResponse.json();
            const stats = body && body.data ? body.data : body;
            updateStats(stats);
        } else {
            console.log('Admin: Stats failed:', await statsResponse.text());
        }
        
        // Load users
        await loadUsers();
        
    } catch (error) {
        console.error('Admin: Error loading admin data:', error);
        showNotification('Error loading admin data', 'danger');
    }
}

function updateStats(stats) {
    document.getElementById('totalUsers').textContent = stats.total_users;
    document.getElementById('activeUsers').textContent = stats.active_users;
    document.getElementById('adminUsers').textContent = stats.admin_users;
    document.getElementById('totalStorage').textContent = formatBytes(stats.total_storage_used);
}

async function loadUsers() {
    const token = localStorage.getItem('access_token');
    console.log('Admin: Loading users...');
    
    try {
        const response = await apiRequest(`/api/admin/users?page=${currentPage}&size=${pageSize}`);
        
        console.log('Admin: Users response:', response.status);
        
        if (response.ok) {
            const body = await response.json();
            const data = body && body.data ? body.data : body;
            console.log('Admin: Users data:', data);
            allUsers = data.users || data;
            displayUsers(allUsers);
            if (data.total !== undefined) {
            updatePagination(data.total, data.page, data.size);
            }
        } else {
            const errorText = await response.text();
            console.log('Admin: Users error:', errorText);
            showNotification('Error loading users', 'danger');
        }
    } catch (error) {
        console.error('Admin: Error loading users:', error);
        showNotification('Error loading users', 'danger');
    }
}

function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>No users found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.id}</td>
            <td>
                <strong>${user.username}</strong>
            </td>
            <td>${user.email}</td>
            <td>${user.full_name || '-'}</td>
            <td>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-danger'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <span class="badge ${user.is_admin ? 'bg-warning' : 'bg-info'}">
                    ${user.is_admin ? 'Admin' : 'User'}
                </span>
            </td>
            <td>
                <small>${formatBytes(user.used_storage)} / ${formatBytes(user.storage_quota)}</small>
            </td>
            <td>
                <small>${new Date(user.created_at).toLocaleDateString()}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-${user.is_active ? 'warning' : 'success'}" 
                            onclick="toggleUserStatus(${user.id}, ${user.is_active})" 
                            title="${user.is_active ? 'Deactivate' : 'Activate'}">
                        <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    // Update filter info
    const searchTerm = document.getElementById('searchUsers').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const roleFilter = document.getElementById('filterRole').value;
    updateFilterInfo(users.length, searchTerm, statusFilter, roleFilter);
}

function updatePagination(total, page, size) {
    const totalPages = Math.ceil(total / size);
    const pagination = document.getElementById('usersPagination');
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${page === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${page - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        paginationHTML += `
            <li class="page-item ${i === page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${page === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${page + 1})">Next</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    loadUsers();
}

// Search and filter functions
document.getElementById('searchUsers').addEventListener('input', function() {
    applyFilters();
});

document.getElementById('filterStatus').addEventListener('change', function() {
    applyFilters();
});

document.getElementById('filterRole').addEventListener('change', function() {
    applyFilters();
});

function applyFilters() {
    const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const roleFilter = document.getElementById('filterRole').value;
    
    const filteredUsers = allUsers.filter(user => {
        const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
        user.email.toLowerCase().includes(searchTerm) ||
                             (user.full_name && user.full_name.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || 
                             (statusFilter === 'active' && user.is_active) ||
                             (statusFilter === 'inactive' && !user.is_active);
        
        const matchesRole = !roleFilter || 
                           (roleFilter === 'admin' && user.is_admin) ||
                           (roleFilter === 'user' && !user.is_admin);
        
        return matchesSearch && matchesStatus && matchesRole;
    });
    
    displayUsers(filteredUsers);
    updateFilterInfo(filteredUsers.length, searchTerm, statusFilter, roleFilter);
}

function updateFilterInfo(count, search, status, role) {
    document.getElementById('usersCount').textContent = `${count} users`;
    
    const filterParts = [];
    if (search) filterParts.push(`Search: "${search}"`);
    if (status) filterParts.push(`Status: ${status}`);
    if (role) filterParts.push(`Role: ${role}`);
    
    const filterInfo = filterParts.length > 0 ? `Filtered by: ${filterParts.join(', ')}` : 'All users';
    document.getElementById('filterInfo').textContent = filterInfo;
}

function clearFilters() {
    document.getElementById('searchUsers').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterRole').value = '';
    applyFilters();
    showNotification('Filters cleared', 'info');
}

// Action functions
function refreshUsers() {
    loadUsers();
    showNotification('Users list refreshed', 'success');
}

async function exportUsers() {
    const exportBtn = document.querySelector('button[onclick="exportUsers()"]');
    const originalText = exportBtn.innerHTML;
    
    try {
        // Get current filters
        const searchTerm = document.getElementById('searchUsers').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const roleFilter = document.getElementById('filterRole').value;
        
        // Build query parameters
        const params = new URLSearchParams();
        if (searchTerm) params.append('search', searchTerm);
        if (statusFilter) params.append('status', statusFilter);
        if (roleFilter) params.append('role', roleFilter);
        
        // Show loading state
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exporting...';
        exportBtn.disabled = true;
        
        // Make request with filters
        const response = await apiRequest(`/api/admin/users/export?${params.toString()}`);
        
        if (response.ok) {
            // Get filename from response headers or use default
            const contentDisposition = response.headers.get('Content-Disposition');
            const filename = contentDisposition 
                ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                : 'users_export.csv';
            
            // Download file
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Users exported successfully!', 'success');
        } else {
            throw new Error('Export failed');
        }
        
    } catch (error) {
        showNotification('Error exporting users: ' + error.message, 'danger');
    } finally {
        // Restore button state
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    }
}

function createUser() {
    // Open create user modal
    const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
    modal.show();
}

function editUser(userId) {
    // Open edit user modal
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
    loadUserForEdit(userId);
}

async function toggleUserStatus(userId, currentStatus) {
    if (confirm(`Are you sure you want to ${currentStatus ? 'deactivate' : 'activate'} this user?`)) {
        try {
        const response = await apiRequest(`/api/admin/users/${userId}/toggle`, {
            method: 'POST',
            body: JSON.stringify({active: !currentStatus})
        });
            
            if (response.ok) {
                showNotification('User status updated successfully', 'success');
                loadUsers();
            } else {
                throw new Error('Failed to update user status');
            }
        } catch (error) {
            showNotification('Error updating user status', 'danger');
        }
    }
}

async function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        try {
            const response = await apiRequest(`/api/admin/users/${userId}/delete`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('User deleted successfully', 'success');
                loadUsers();
            } else {
                throw new Error('Failed to delete user');
            }
        } catch (error) {
            showNotification('Error deleting user', 'danger');
        }
    }
}

function systemSettings() {
    // Open system settings modal
    const modal = new bootstrap.Modal(document.getElementById('systemSettingsModal'));
    modal.show();
}

function viewLogs() {
    // Find logs section or create it if it doesn't exist
    let logsSection = document.getElementById('logsSection');
    
    if (!logsSection) {
        // Create logs section if it doesn't exist
        logsSection = document.createElement('div');
        logsSection.id = 'logsSection';
        logsSection.className = 'card mt-4';
        logsSection.innerHTML = `
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>System Logs</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <select class="form-select" id="logTypeFilter">
                            <option value="main">Main Logs</option>
                            <option value="auth">Auth Logs</option>
                            <option value="files">Files Logs</option>
                            <option value="admin">Admin Logs</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary" onclick="loadLogs(document.getElementById('logTypeFilter').value)">
                            <i class="fas fa-refresh me-2"></i>Refresh
                        </button>
                    </div>
                </div>
                <div id="logsContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Insert after the main content
        const mainContent = document.querySelector('.container-fluid');
        if (mainContent) {
            mainContent.appendChild(logsSection);
        }
    }
    
    // Scroll to logs section
    logsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Load logs
    loadLogs('main');
}

function backupData() {
    // Open backup modal
    const modal = new bootstrap.Modal(document.getElementById('backupModal'));
    modal.show();
}

// Logs functionality
async function loadLogs(logType = 'main') {
    const logsContainer = document.getElementById('logsContainer');
    if (!logsContainer) {
        console.error('Logs container not found');
        return;
    }
    
    try {
        const response = await fetch(`/admin/logs?log_type=${logType}&limit=50`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            const body = await response.json();
            const logs = body && body.data ? body.data.logs : (body.logs || []);
            displayLogs(logs);
        } else {
            throw new Error('Failed to load logs');
        }
    } catch (error) {
        logsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Ошибка загрузки логов: ${error.message}
            </div>
        `;
    }
}

function displayLogs(logs) {
    const container = document.getElementById('logsContainer');
    if (!container) {
        console.error('Logs container not found for display');
        return;
    }
    
    if (logs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                <p class="text-muted">Логи не найдены</p>
            </div>
        `;
        return;
    }
    
    let logsHtml = '<div class="table-responsive"><table class="table table-sm">';
    logsHtml += '<thead><tr><th>Время</th><th>Уровень</th><th>Сообщение</th></tr></thead><tbody>';
    
    logs.forEach(log => {
        const levelClass = log.level === 'ERROR' ? 'text-danger' : 
                          log.level === 'WARNING' ? 'text-warning' : 
                          log.level === 'INFO' ? 'text-info' : '';
        
        logsHtml += `
            <tr>
                <td><small>${log.timestamp}</small></td>
                <td><span class="badge bg-secondary ${levelClass}">${log.level}</span></td>
                <td><small>${log.message}</small></td>
            </tr>
        `;
    });
    
    logsHtml += '</tbody></table></div>';
    container.innerHTML = logsHtml;
}

// Load data on page load
// Modal functions
async function submitCreateUser() {
    const formData = {
        email: document.getElementById('createEmail').value,
        username: document.getElementById('createUsername').value,
        password: document.getElementById('createPassword').value,
        is_admin: document.getElementById('createIsAdmin').checked,
        storage_quota: document.getElementById('createStorageQuota').value * (1024**3)
    };
    
    try {
        const response = await apiRequest('/api/admin/users/create', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showNotification('User created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
            loadUsers();
        } else {
            throw new Error('Failed to create user');
        }
    } catch (error) {
        showNotification('Error creating user: ' + error.message, 'danger');
    }
}

async function submitEditUser() {
    const userId = document.getElementById('editUserId').value;
    const formData = {
        email: document.getElementById('editEmail').value,
        username: document.getElementById('editUsername').value,
        is_active: document.getElementById('editIsActive').checked,
        is_admin: document.getElementById('editIsAdmin').checked,
        storage_quota: document.getElementById('editStorageQuota').value * (1024**3)
    };
    
    const password = document.getElementById('editPassword').value;
    if (password) {
        formData.password = password;
    }
    
    try {
        const response = await apiRequest(`/api/admin/users/${userId}`, {
            method: 'PUT',
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showNotification('User updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            loadUsers();
        } else {
            throw new Error('Failed to update user');
        }
    } catch (error) {
        showNotification('Error updating user: ' + error.message, 'danger');
    }
}

function loadUserForEdit(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (user) {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editIsActive').checked = user.is_active;
        document.getElementById('editIsAdmin').checked = user.is_admin;
        document.getElementById('editStorageQuota').value = user.storage_quota / (1024**3);
    }
}

async function saveSystemSettings() {
    const settingsPayload = {
        site_name: document.getElementById('siteName').value,
        default_quota: document.getElementById('defaultQuota').value,
        session_timeout: document.getElementById('sessionTimeout').value,
        require_email_verification: document.getElementById('requireEmailVerification').checked
    };
    try {
        const response = await fetch('/admin/settings', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settingsPayload)
        });
        const body = await response.json();
        if (response.ok && (body.success === undefined || body.success)) {
            showNotification('System settings saved!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('systemSettingsModal')).hide();
        } else {
            throw new Error(body.message || 'Failed to save settings');
        }
    } catch (e) {
        showNotification('Error saving settings: ' + e.message, 'danger');
    }
}

async function startBackup() {
    const backupType = document.getElementById('backupType').value;
    const compression = document.getElementById('compression').value;
    const includeUserFiles = document.getElementById('includeUserFiles') ? document.getElementById('includeUserFiles').checked : true;
    
    const backupBtn = document.querySelector('button[onclick="startBackup()"]');
    const originalText = backupBtn.innerHTML;
    
    try {
        // Show loading state
        backupBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Backup...';
        backupBtn.disabled = true;
        
        // Make request to create backup
        const response = await fetch('/admin/backup', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                backup_type: backupType,
                compression: compression,
                include_user_files: includeUserFiles
            })
        });
        
        if (response.ok) {
            const body = await response.json();
            const result = body && body.data ? body.data : body;
            showNotification(`Backup created successfully! ID: ${result.backup_id}`, 'success');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('backupModal')).hide();
            
            // Download the backup file
            if (result.download_url) {
                try {
                    // Fetch file with authorization
                    const downloadResponse = await fetch(result.download_url, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });
                    
                    if (downloadResponse.ok) {
                        const blob = await downloadResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = result.filename;
                        downloadLink.style.display = 'none';
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        window.URL.revokeObjectURL(url);
                        
                        showNotification(`Downloading backup: ${result.filename}`, 'info');
                    } else {
                        throw new Error('Download failed');
                    }
                } catch (downloadError) {
                    // Fallback: try direct window.open with token
                    try {
                        const token = localStorage.getItem('access_token');
                        const downloadUrl = `${result.download_url}?token=${token}`;
                        window.open(downloadUrl, '_blank');
                        showNotification(`Opening download: ${result.filename}`, 'info');
                    } catch (fallbackError) {
                        showNotification('Error downloading backup: ' + downloadError.message, 'danger');
                    }
                }
            }
        } else {
            throw new Error('Backup creation failed');
        }
        
    } catch (error) {
        showNotification('Error creating backup: ' + error.message, 'danger');
    } finally {
        // Restore button state
        backupBtn.innerHTML = originalText;
        backupBtn.disabled = false;
    }
}

// Page-specific init handled in admin.js
</script>
{% endblock %}
